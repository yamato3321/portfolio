package com.example.portfolio.controller;


import java.security.Principal;
import java.util.List;
import java.util.Optional;

import jakarta.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.example.portfolio.entity.Category;
import com.example.portfolio.entity.Task;
import com.example.portfolio.entity.User;
import com.example.portfolio.service.CategoryService;
import com.example.portfolio.service.TaskService;
import com.example.portfolio.service.UserService;

@Controller
public class TaskController {

    @Autowired
    private TaskService taskService;

    @Autowired
    private UserService userService;
    
    @Autowired
    private CategoryService categoryService;

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§è¡¨ç¤º
    @GetMapping("/tasks")
    public String showTaskList(@RequestParam( defaultValue = "asc")String sort, 
    							@RequestParam(defaultValue = "deadline")String sortBy,
    							@RequestParam (required = false) String status,
    							@RequestParam(required = false) String keyword,
    							@RequestParam(defaultValue = "0") int page,
    							Model model, Principal principal) {
    	
        Optional<User> userOpt = userService.findByEmail(principal.getName());
        
        if(userOpt.isEmpty()) {
        	 model.addAttribute("error", "æœªç™»éŒ²ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚");
             return"login";
        }
        
        User user = userOpt.get();
        
     // ä¸¦ã³é †ã®æŒ‡å®š
        Sort sortOption = "desc".equalsIgnoreCase(sort)?
        		Sort.by(Sort.Direction.DESC,sortBy):
        		Sort.by(Sort.Direction.ASC,sortBy);
        
     // ãƒšãƒ¼ã‚¸æƒ…å ±ã®æŒ‡å®šï¼ˆ1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Š5ä»¶ï¼‰
        Pageable pageable = PageRequest.of(page,5,sortOption);
        
        Page<Task> taskPage;
        
        //ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ å®Œäº†ãƒ»æœªå®Œäº†é¸åˆ¥  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿
        if (keyword != null && !keyword.isEmpty()) {
            if ("completed".equalsIgnoreCase(status)) {
                taskPage = taskService.searchTasksWithStatus(user, keyword, true, pageable);
            } else if ("incomplete".equalsIgnoreCase(status)) {
                taskPage = taskService.searchTasksWithStatus(user, keyword, false, pageable);
            } else {
                taskPage = taskService.searchTasks(user, keyword, pageable); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç„¡è¦–
            }
        } else {
            if ("completed".equalsIgnoreCase(status)) {
                taskPage = taskService.getTasksByUserAndStatus(user, true, pageable);
            } else if ("incomplete".equalsIgnoreCase(status)) {
                taskPage = taskService.getTasksByUserAndStatus(user, false, pageable);
            } else {
                taskPage = taskService.getTasksByUser(user, pageable); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç„¡è¦–
            }
        }
        
        //ï¼ˆãƒ¡ãƒ¢ï¼šPageã‹ã‚‰Listã«å¤‰æ›ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
        List<Task> filteredTasks = taskPage.getContent();
        
        model.addAttribute("tasks", taskPage); // Pageå‹ã®ã¾ã¾æ¸¡ã™
        model.addAttribute("filteredTasks", filteredTasks); // å®Ÿéš›è¡¨ç¤ºã™ã‚‹ç”¨
        model.addAttribute("sort", sort);
        model.addAttribute("sortBy", sortBy);
        model.addAttribute("status", status);
        model.addAttribute("keyword", keyword);
        model.addAttribute("loginName", user); //ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¤º

        
        return "task-list";
        	
        
    }

    // ã‚¿ã‚¹ã‚¯ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    @GetMapping("/new")
    public String showTaskForm(Model model) {
    	
        model.addAttribute("task", new Task());
        
        List<Category> categories = categoryService.findAll();
        model.addAttribute("categories", categories);
        
        return "task-form";
    }


    // ã‚¿ã‚¹ã‚¯ç™»éŒ²å‡¦ç†
    @PostMapping("/new")
    public String createTask(@Valid @ModelAttribute Task task,
    		 					BindingResult bindingResult,
    		 					@RequestParam("categoryId")Long categoryId,
    							Principal principal,
    							Model model) {
    	
    	if(bindingResult.hasErrors()) {
    		   // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å†ã‚»ãƒƒãƒˆï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ã«å¿…è¦ï¼‰
    		model.addAttribute("categories", categoryService.findAll());
    		return "task-form";
    	}
    	
        Optional<User> userOpt = userService.findByEmail(principal.getName());
        Optional<Category> categoryOpt = categoryService.findById(categoryId);
        
        if (userOpt.isPresent() && categoryOpt.isPresent()) {
            task.setUser(userOpt.get());
            task.setCategory(categoryOpt.get()); // ğŸ‘ˆ ã‚«ãƒ†ã‚´ãƒªã‚’æ‰‹å‹•ã§ã‚»ãƒƒãƒˆ
            taskService.save(task);
            return "redirect:/tasks";
        } else {
            return "redirect:/login";
        }}
    }
    //ã€€ã‚¿ã‚¹ã‚¯ç·¨é›†ç”»é¢
    @GetMapping("/tasks/edit/{id}")
    public String showEditForm(@PathVariable Long id, Model model, Principal principal) {

    	Optional<User> userOpt = userService.findByEmail(principal.getName());
        Optional<Task> taskOpt = taskService.findById(id);

        if (userOpt.isPresent() && taskOpt.isPresent()) {
            User loginUser = userOpt.get();
            Task task = taskOpt.get();

            if (task.getUser().getId().equals(loginUser.getId())) {
                model.addAttribute("task", task);
                return "task-edit";
            }
        }
        return "redirect:/tasks";
    }
    
 //ã€€ã‚¿ã‚¹ã‚¯ç·¨é›†å¾Œ
    @PostMapping("/tasks/edit/{id}")
    public String updateTask(@PathVariable Long id,
    						@Valid @ModelAttribute Task updatedTask,
    						BindingResult bindingResult,
    						Principal principal,
    						Model model) {
    	
    	if(bindingResult.hasErrors()) {
    		model.addAttribute("task", updatedTask);
    		return "task-edit";
    	}
    		
        Optional<User> userOpt = userService.findByEmail(principal.getName());
        Optional<Task> taskOpt = taskService.findById(id);

        if (userOpt.isPresent() && taskOpt.isPresent()) {
            Task existingTask = taskOpt.get();

            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼šã‚¿ã‚¹ã‚¯ã®æ‰€æœ‰è€…ã¨ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸€è‡´ã™ã‚‹ã‹
            if (existingTask.getUser().getId().equals(userOpt.get().getId())) {
                // æ›´æ–°å†…å®¹ã‚’åæ˜ 
                existingTask.setTitle(updatedTask.getTitle());
                existingTask.setDescription(updatedTask.getDescription());
                existingTask.setDeadline(updatedTask.getDeadline());
                existingTask.setCompleted(updatedTask.isCompleted());

                taskService.save(existingTask);
                
                return "redirect:/tasks";
            }
            
        }
        	
        	return "redirect:/login";
        	
        
    }


 // ã‚¿ã‚¹ã‚¯å‰Šé™¤å‡¦ç†
    @PostMapping("/delete/{id}")
    public String deleteTask(@PathVariable Long id, Principal principal) {
        Optional<User> userOpt = userService.findByEmail(principal.getName());
        Optional<Task> taskOpt = taskService.findById(id);

        if (userOpt.isPresent() && taskOpt.isPresent()) {
            Task task = taskOpt.get();

            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰€æœ‰è€…ã‹ç¢ºèª
            if (task.getUser().getId().equals(userOpt.get().getId())) {
                taskService.deleteTask(task); // â† å®Ÿè¡Œ
            }
        }

        return "redirect:/tasks";
    }
   
  //å®Œäº†ãƒœã‚¿ãƒ³æ¨ã—ãŸã‚‰ãã®å ´ã§ON,OFåˆ‡ã‚Šæ›¿ã‚ã‚‹
    @PostMapping("/tasks/update-status")
    public String updateTaskStatus(@RequestParam Long id,
                                   @RequestParam(required = false) String completed,
                                   Principal principal) {

        Optional<User> userOpt = userService.findByEmail(principal.getName());
        Optional<Task> taskOpt = taskService.findById(id);

        if (userOpt.isPresent() && taskOpt.isPresent()) {
            User loginUser = userOpt.get();
            Task task = taskOpt.get();

            if (task.getUser().getId().equals(loginUser.getId())) {
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ãªã‚‰"on"ã€ã‚ªãƒ•ãªã‚‰nullã«ãªã‚‹
                task.setCompleted(completed != null);
                taskService.save(task);
            }
        }

        return "redirect:/tasks";
    }


}
